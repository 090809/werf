#!/usr/bin/env ruby
# -*- mode: ruby -*-
# vi: set ft=ruby :

require 'rubygems'
require 'dapp'

begin
  begin
    Dapp::CLI.new.run
  rescue ::SystemExit
    raise
  rescue ::Exception => e
    old_umask = ::File.umask(0)

    ::File.open('/tmp/dapp-stacktrace.out', 'a', 0666) do |dapp_stacktrace|
      dapp_stacktrace.flock(File::LOCK_EX)
      dapp_stacktrace.write [*e.backtrace, "\n"].join("\n")
    end

    ::File.umask(old_umask)

    $stderr.puts "\033[1m\033[31mStacktrace dumped to /tmp/dapp-stacktrace.out\033[0m"

    raise
  end
rescue Dapp::Error::Shellout => e
  $stderr.puts(Dapp::Helper::NetStatus.message(e))
  exit 1
rescue Dapp::Error::Base, NetStatus::Exception => e
  $stderr.puts(Dapp::Project.paint_string(Dapp::Helper::NetStatus.message(e), :warning))
  exit 1
rescue Interrupt => _e
  $stderr.puts(Dapp::Project.paint_string('Interrupted', :warning))
  exit 1
rescue Errno::EACCES => _e
  $stderr.puts(Dapp::Project.paint_string('Permission denied!', :warning))
  exit 1
end
