---
title: Проброска кода в собираемый образ - git
sidebar: doc_sidebar
permalink: git.html
folder: directive
---

Код приложения можно пробросить в собираемый образ с помощью директивы git.

Поддержка сборщиками

- Shell - нет
- Chef - да
- Ansible - да

# Проблемы

Первая проблема, с которой предстоит столкнуться: как добиться минимальной задержки между коммитом и получением готового образа для дальнейшего тестирования/деплоя. Большая часть коммитов в репозиторий приложения относится к обновлению кода самого самого приложения. В этом случае сборка нового образа должна представлять собой не более, чем применение патча к файлам предыдущего образа.

Вторая проблема: если после сделанных изменений в исходном коде приложения и сборки образа эти изменения были отменены (например, через git revert) в следующем коммите — должен сработать кэш сборщика образов. Т.е. собираемые сборщиком образа должны кэшироваться по содержимому изменений в файлах git репозитория, а не по факту наличия этих изменений.

Третья проблема возникает, когда подготовка образа включает в себя, например, установку внешних зависимостей gem'ов в образ на основе Gemfile и Gemfile.lock из git-репозитория. В таком случае необходимо пересобирать стадию, на которой происходит установка этих зависимостей, если поменялся Gemfile или Gemfile.lock.

Четвертая проблема: добавлять файлы из git репозитория в образ путем копирования всего дерева исходников необходимо выполнять редко, основным способом добавления изменения должно служить наложение патчей.

* Problem: i want to copy only particular files from my repo to image. Or i want to exclude some directories.
* your app is in git repository. .dockerignore
* directives: git
* Enhanced layers cache for faster builds
  * Problems:
    * cache depends only on Dockerfile content, not on my changes of source files.
    * cache is local.
    * Stages: what is a checksum? what is a sequence of stages/lifecycle of build process (the order of stage execution)? 
  * directives: git.add.stage_dependencies

# Правила использования

* Пути добавления не должны пересекаться.
* Изменение любого параметра ведёт к смене сигнатур, пересборке связанных [стадий](stages.html#стадия) приложения.
* Приложение может содержать любое количество git-директив.

## Ansible-сборщик

@todo: описать

## Chef-сборщик

Директива `git [<url>]` позволяет определить один или несколько git-директив.

* Поддерживается два типа git-директив, local и remote.
* Необязательный параметр \<url\> соответствует адресу удалённого git-репозитория (remote).
* Для добавления git-директивы необходимо использовать поддирективу add.
  * Принимает параметр \<cwd\> (по умолчанию используется '\\').
  * Параметры \<include_paths\>, \<exclude_paths\>, \<owner\>, \<group\>, \<to\> определяются в контексте.
  * Параметры \<branch\>, \<commit\> могут быть определены в контексте remote git-директивы.
* В контексте директивы можно указать базовые параметры git-директив, которые могут быть переопределены в контексте каждого из них.
  * \<owner\>.
  * \<group\>.
  * \<branch\>.
  * \<commit\>.
  
  
### Параметры артефакта

#### Общие
* to: абсолютный путь, в который будут копироваться ресурсы.
* cwd: абсолютный путь, определяет рабочую директорию.
* include_paths: добавить только указанные относительные пути.
* exclude_paths: игнорировать указанные относительные пути.
* owner: определить пользователя.
* group: определить группу.

#### Дополнительные для remote git-директив
* branch: определить branch.
* commit: определить commit.

#### Управление запуском сборки при изменении файлов

Директива `git.add.stage_dependencies` позволяет определить для стадий install, before_setup, setup и build_artifact зависимости от файлов git-директивы.

* При изменении содержимого указанных файлов, произойдет пересборка зависимой стадии.
* Учитывается содержимое и имена файлов.
* Поддерживаются glob-паттерны.
* Пути в \<glob\> указываются относительно cwd git-директивы.
* Директории игнорируются.
* \<glob\> чувствителен к регистру.

### Примеры
  
#### Как собрать образ с несколькими git-директивами
```ruby
dimg do
  docker.from 'image:tag'

  git do
    add '/' do
      exclude_paths 'assets'
      to '/app'
    end

    add '/assets' do
      to '/web/site.narod.ru/assets_with_strange_name'
    end
  end

  git 'https://site.com/com/project.git' do
    owner 'user4'
    group 'stuff'

    add '/' do
      to '/project'
    end
  end
end
```

### Как определить зависимости для нескольких git-директив
```ruby
dimg do
  docker.from 'image:tag'

  git do
    add '/' do
      to '/app'

      stage_dependencies do
        install 'flag'
      end
    end

    add '/assets' do
      to '/web/site.narod.ru/assets_with_strange_name'
      stage_dependencies.setup '*.less'
    end
  end
end
```
