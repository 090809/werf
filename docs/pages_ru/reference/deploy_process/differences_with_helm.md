---
title: Отличия от Helm
sidebar: documentation
permalink: documentation/reference/deploy_process/differences_with_helm.html
author: Timofey Kirillov <timofey.kirillov@flant.com>
---

## Встроенный Helm-клиент и Tiller

Helm 2 использует компонент [Tiller](https://helm.sh/docs/glossary/#tiller), который управляет [релизами]({{ site.baseurl }}/documentation/reference/deploy_process/deploy_into_kubernetes.html#release): выполняет операции создания, обновления, удаления и вывода списка релизов.

Деплой с помощью **werf** не требует установленного в кластере Kubernetes Tiller. Helm-клиент и Tiller полностью встроены в **werf**, и Tiller выполняется локально (без сетевых gRPC запросов) в рамках единого процесса **werf** во время деплоя.

**Werf** [полностью совместим]({{ site.baseurl }}/documentation/reference/deploy_process/deploy_into_kubernetes.html#helm-compatibility-notice) с существующими инсталляциями Helm 2.

Такая архитектура дает **werf** ряд преимуществ, которые рассматриваются далее.

### Возможность по-своему реализовать отслеживание ресурсов

**Werf** импортирует кодовую базу Helm и релизовывает по своему ключевые шаги принятого в Helm процесса деплоя. Реализация в **werf** позволяет [отслеживать журналы (в stdout) ресурсов](#правильное-отслеживание-развернутых-ресурсов) без сложных архитектурных решений, таких как потоковая передача через gRPC с использованием Helm-клиента и Tiller.

### Безопасность

Обычно Tiller устанавливается в кластере Kubernetes с правами администратора. С помощью **werf**, пользователь может более тонко настраивать доступ к кластеру, например, для каждого namespace проекта.

В отличие от Tiller, в **werf** хранилище данных о релизах не привязано к конфигурации кластера или другим параметрам установки. **Werf** может хранить данные о релизах каждого проекта прямо в namespace проекта. Это приводит к тому, что другие проекты в кластере не смогут получить доступ к данным релиза другого проекта, при отсутствии доступа к соответствующему namespace.

### Установка

Поскольку Helm-клиент и Tiller встроены в **werf**, нет необходимости ни в установке Helm-клиента на хосте ни в установке Tiller в кластере.

## Правильное отслеживание развернутых ресурсов

**Werf** отслеживает все ресурсы чарта до тех пор, пока каждый ресурс не перейдет в состояние готовности. В процессе отслеживания **werf** выводит журналы и информацию о текущем состоянии ресурсов, изменениях состояния ресурсов в процессе деплоя, а также информацию о том, чего **werf** ожидает (например готовность каких ресурсов ожидается).

В стандартном Helm, пользователь имеет возможность только указать флаг `--wait` для ожидания ресурсов, но при использовании этого флага Helm не дает никакой интерактивной информации о том, «что происходит сейчас?».

Также, **werf** быстро завершает текущий процесс при возникновении ошибки во время деплоя. При использовании флага `--wait` в стандартном Helm, пользователь должен дождаться истечения таймаута когда что-то пойдет не так. Поскольку неудачные деплои — не редкость, ожидание таймаутов может значительно замедлить работу CI/CD.

Кроме того, поведение при отслеживании по умолчанию можно настроить согласно вашим потребностям, читайте подробнее об этом в [соответствующей статье]({{ site.baseurl }}/documentation/reference/deploy_process/deploy_into_kubernetes.html#настройка-отслеживания-ресурсов).

Отслеживание ресурсов в **werf** реализовано с помощью библиотеки [kubedog](https://github.com/flant/kubedog).

## Использование аннотаций и меток ресурсов чарта

Ко всем ресурсам чарта (включая хуки) **werf** автоматически добавляет аннотации, например такие как (при использовании в GitLab):
* `"project.werf.io/git": $CI_PROJECT_URL`;
* `"ci.werf.io/commit": $CI_COMMIT_SHA`;
* `"gitlab.ci.werf.io/pipeline-url":  $CI_PROJECT_URL/pipelines/$CI_PIPELINE_ID`;
* `"gitlab.ci.werf.io/job-url": $CI_PROJECT_URL/pipelines/$CI_JOB_ID`.

Пользователь может передавать любые дополнительные аннотации и метки при вызове команды `werf deploy`, — **werf** установит эти аннотации и метки всем ресурсам чарта.

Эта возможность позволяет группировать ресурсы по имени проекта, URL и т.д., например для использования в мониторинге. Читайте подробнее про основы деплоя в [соответствующей статье]({{ site.baseurl }}/documentation/reference/deploy_process/deploy_into_kubernetes.html#аннотации-и-метки-ресурсов-чарта).

У Helm пока нет такого функционала, и он [не появится](https://github.com/helm/helm/pull/2631) в ближайшем будущем.

## Безопасный параллельный деплой

**Werf** использует блокировки для предотвращения параллельного деплоя или удаления ресурсов в рамках одного релиза. Блокировка выполняется по имени релиза.

Helm не использует каких-либо блокировок, поэтому параллельный деплой может приводить к неожиданным результатам.

## Встроенная поддержка секретов

У **werf** есть встроенные инструменты работы с файлами секретов и секретными данными. Эта возможность позволяет хранить конфиденциальные данные прямо в репозитории проекта. Читай подробнее об этом в статьях по [основам деплоя]({{ site.baseurl }}/documentation/reference/deploy_process/deploy_into_kubernetes.html) и [работе с секретами]({{ site.baseurl }}/documentation/reference/deploy_process/working_with_secrets.html).

## Интеграция с описанной конфигурацией образа

**Werf** расширяет возможности Helm благодаря специальным функциям шаблонов, таким как `werf_container_image` и `werf_container_env`. Эти функции возвращают корректные имена образов и секции переменных, для использования в шаблонах чарта с учетом описанного в конфигурации образа. Читай подробнее про [основы деплоя]({{ site.baseurl }}/documentation/reference/deploy_process/deploy_into_kubernetes.html).

Таким образом, **werf** значительно упрощает использование пользовательских образов в шаблонах: **werf** генерирует «правильные» имена и теги Docker-образа, а также гарантирует, что нужная версия образа будет скачана со стороны Kubernetes когда это будет необходимо.

В случае же стандартного Helm, пользователю необходимо придумать собственную систему передачи актуальных имен образов.

## Генерация чартов

Во время деплоя происходит создание временного Helm-чарта. Этот чарт содержит:

* Вызов дополнительных функции Go-шаблонов: `werf_container_image`, `werf_container_env` и других. Эти функции описаны в соответствующей [статье]({{ site.baseurl }}/documentation/reference/deploy_process/deploy_into_kubernetes.html#шаблоны).
* Расшифрованные данные секретов из файла `secret-values.yaml`. Работа с этими секретами описана в [соответствующей статье]({{ site.baseurl }}/documentation/reference/deploy_process/working_with_secrets.html#шифрация-секретных-переменных).

Затем, временный чарт отправляется в подсистему Helm внутри **werf**. **Werf** удаляет этот чарт при завершении работы команды деплоя.

### Не нужен Chart.yaml

Helm-чарт требует обязательного наличия файла `Chart.yaml` в корне папки чарта, где должны быть определены имя и версия чарта.

**Werf** генерирует этот файл при передаче временного чарта в подсистему Helm. В сгенерированном файле имя чарта совпадает с именем проекта из конфигурации `werf.yaml`, а версия всегда равна `0.1.0` (это неважное вспомогательное поле).

Если пользователь сам создал файл `Chart.yaml`, то **werf** перепишет его сгенерированным файлом и выведет соответствующее предупреждение.

## Фиксированный путь Helm-чарта в проекте

**Werf** требует, чтобы [чарт]({{ site.baseurl }}/documentation/reference/deploy_process/deploy_into_kubernetes.html#чарт) был размещен в папке `.helm`, в той же папке где находится файл конфигурация `werf.yaml`.

Helm не определяет фиксированного места размещения чарта в проекте.

## Проверка ресурсов чарта

Ошибки, такие как несуществующие в конфигурации ресурсов шаблонов чарта поля, не отображаются стандартным Helm. Нет обратной связи — пользователь не знает о наличии таких ошибок.

**Werf** выводит предупреждения (с префиксом `WARNINGS`) об ошибках проверки, а также записывает эти предупреждения в аннотацию соответствующего ресурса (чтобы их можно было легко получить с помощью CLI-команд из нескольких кластеров). Читайте более подробно [здесь]({{ site.baseurl }}/documentation/reference/deploy_process/deploy_into_kubernetes.html#проверка-манифестов-ресурсов).

## Трехстороннее слияние и применение изменений

В **werf** реализовано два метода применения изменений — двухэтапный (как в Helm 2) и трехэтапный методы слияния. Оба способа совместимы с существующими инсталляциями Helm 2 в кластере

Подробнее о методах применения изменений ресурсов можно прочитать в [соответствующей статье]({{site.baseurl}}/documentation/reference/deploy_process/resources_update_methods_and_adoption.html) документации, а также в [статье на Хабр "3-way merge в werf: деплой в Kubernetes с Helm «на стероидах»"](https://habr.com/ru/company/flant/blog/476646/).

Также в **werf** реализована возможность явным образом перенести в Helm-релиз уже существующие ресурсы в работающем кластере Kubernetes (для этого необходимо явно вручную установить аннотацию у желаемого ресурса и развернуть чарт с помощью **werf**). Более подробная информация об использовании ресурсов доступна в соответствующей [статье]({{ site.baseurl }}/documentation/reference/deploy_process/resources_update_methods_and_adoption.html#принятие-существующих-ресурсов).
