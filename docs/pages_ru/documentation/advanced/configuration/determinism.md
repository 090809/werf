---
title: Детерминизм
sidebar: documentation
permalink: documentation/advanced/configuration/determinism.html
---

Начиная с версии v1.2 werf вводит так называемый _режим детерминизма_ по умолчанию.

В данном режиме все конфигурационные файлы читаются из текущего коммита локального гит-репозитория. Запрещено иметь некоммитнутые изменения в этих файлах — werf упадёт с ошибкой при наличии таких файлов. С помощью опции `--non-strict-determinism-inspection` можно понизить уровень инспекции детерминизма до уровня предупреждений в логе о наличии некоммитнутых файлов, однако werf всё равно будет читать эти файлы из текущего коммита локального гит-репозитория.

Для следующих файлов возможно отключение режима детерминизма и чтение напрямую из рабочей директории с помощью флага `--disable-determinism`:
 - `werf.yaml`;
 - `.werf/**/*.tmpl` дополнительные файлы go-шаблонов для `werf.yaml`;
 - `.helm/templates`;
 - `.helm/values.yaml`;
 - `.helm/secret-values.yaml`;
 - `.helm/Chart.yaml`.
 
**Важно**. Отключать режим детерминизма не рекомендовано, т.к. это повышает вероятность написания конфигурации, которая приведёт к невоспроизводимым сборкам и выкатам приложения. Важно использовать детерминированный режим для построения конфигурации соответствующей подходу GitOps.

### Функция `.Files.Get`

В режиме детерминизма функция `.Files.Get` доступная при чтении конфига `werf.yaml будет читать файлы только из текущего коммита гит-репозитория.

При указании флага `--disable-determinism` werf будет читать указанный аргументом к функции файл напрямую из рабочей директории проекта.

### Функции go-шаблонов для доступа к переменным окружения

Функции [`{{ env }}` и `{{ expandenv }}`]({{ "documentation/advanced/configuration/supported_go_templates.html" | relative_url }}) доступны для использования при чтении конфига `werf.yaml` только при указании флага `--disable-determinism`.

### Директива mount

[Директива `mount`]({{ "documentation/reference/werf_yaml.html" | relative_url}}) для сборщика образов stapel доступна для использования только при указании флага `--disable-determinism`.

## Сборщик Dockerfile

Werf использует контекст для Dockerfile и сам Dockerfile только из текущего коммита локального гит-репозитория.

**Важно:** Нет способа выключить чтение контекста и Dockerfile из текущего коммита для данного сборщика, флаг `--disable-determinism` не влияет на работу данного сборщика.

Однако есть один способ явным образом добавить файлы вне гит-репозитория в контекст сборки Dockerfile: с помощью [директивы `contextAddFile`]({{ "documentation/reference/werf_yaml.html" | relative_url}}):

```
context: app
dockerfile: Dockerfile
contextAddFile:
 - myfile
 - dir/a.out
```

В данной конфигурации werf создаст контекст для Dockerfile, состоящий из:
 - директории `app` из текущего коммита локального гит-репозитория (эта директория указана директивой `context`);
 - файлов `myfile` и `dir/a.out` из директории `app` в текущей рабочей директории проекта (данные файлы могут быть не коммитнуты в гит и могут быть untracked).

## Резюме

|             | по умолчанию | `--non-strict-determinism-inspection` | `--disable-determinism` |  
| `werf.yaml` | читается из гита, некоммитнутое состояние запрещено | читается из гита, некоммитнутое состояние вызывает предупреждение | читается из рабочей директории, некоммитнутое состояние разрешено |
| `.werf/**/*.tmpl`  | читается из гита, некоммитнутое состояние запрещено | читается из гита, некоммитнутое состояние вызывает предупреждение | читается из рабочей директории, некоммитнутое состояние разрешено |
| `.helm/templates` | читается из гита, некоммитнутое состояние запрещено | читается из гита, некоммитнутое состояние вызывает предупреждение | читается из рабочей директории, некоммитнутое состояние разрешено |
| `.helm/values.yaml` | читается из гита, некоммитнутое состояние запрещено | читается из гита, некоммитнутое состояние вызывает предупреждение | читается из рабочей директории, некоммитнутое состояние разрешено |
| `.helm/secret-values.yaml` | читается из гита, некоммитнутое состояние запрещено | читается из гита, некоммитнутое состояние вызывает предупреждение | читается из рабочей директории, некоммитнутое состояние разрешено |  
| `.helm/Chart.yaml` | читается из гита, некоммитнутое состояние запрещено | читается из гита, некоммитнутое состояние вызывает предупреждение | читается из рабочей директории, некоммитнутое состояние разрешено |
| Dockerfiles specified in the `werf.yaml` |  читается из гита, некоммитнутое состояние запрещено | читается из гита, некоммитнутое состояние вызывает предупреждение | читается из гита (детерминизм невозможно отключить) |
| `context` for dockerfiles specified in the `werf.yaml` |  читается из гита, некоммитнутое состояние запрещено | читается из гита, некоммитнутое состояние вызывает предупреждение | читается из гита (детерминизм невозможно отключить) | 
