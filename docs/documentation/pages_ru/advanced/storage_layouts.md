---
title: Организация хранилища стадий
permalink: advanced/storage_layouts.html
---

В данной статье описано как устроено хранилище собираемых образов в werf, какие бывают типы хранилища, какие функции выполняют эти хранилища, а также различные варианты организации хранилища в проекте.

## Хранилище стадий

Werf собирает образы, состоящие из одной или нескольких стадий. Все стадии собираемых образов сохраняются в так называемое **хранилище стадий** по мере сборки.

Бывает **локальное хранилище** стадий и хранилище стадий в **репозитории** (container registry).

Локальное хранилище стадий может быть использовано _только для локальной разработки_ и на данный момент только для сборки образов. В качестве локального хранилища выступает docker server. Локальное хранилище стадий будет задействовано, например, если вызвать команду `werf build` без аргумента `--repo`.

Во всех остальных случаях кроме локальной разработки, в качестве хранилища стадий всегда выступает репозиторий (container registry). Если запустить сборку с хранилищем стадий в репозитории (например `werf build` с параметром `--repo ghcr.io/example/myrepo`), то werf проверит наличие требуемых стадий в локальном хранилище и скопирует оттуда подходящие стадии, чтобы не пересобирать эти стадии заново.

Ввведём также понятие **инсталляции проекта** — это git-репозиторий проекта и связанные хранилища стадий в репозитории. Предполагается использование во всех вызовах werf одного и того же git-репозитория и одних и тех же хранилищ стадий (может быть указано одно или несколько, подробности далее). Также предполагается, что хранилище стадий инсталляции не может быть удалено или очищено сторонними средствами без негативных последствий для работы werf (например см. [первичный репозиторий](#первичный-репозиторий)), за исключением некоторых типов хранилищ могут быть безопасно удалены в любой момент времени (например см. [кеширующий репозиторий](#кеширующий-репозиторий)).

### Первичный репозиторий

Задаётся параметром `--repo` (или переменной окружения `WERF_REPO`).

Данное хранилище является основным и объединяет в себе несколько функций:

1. История проекта.
    - Хранилище метаданных, связанных с git-репозиторием, для собираемых образов и стадий.
    - История проекта позволяет реализовать продвинутый алгоритм безопасной очистки старых стадий на основе истории git-репозитория (см. команду `werf cleanup`).
2. Синхронизация сборки в распределённом окружении. 
    - Данное хранилище позволяет запускать сборку в распределённом окружении и эффективно переиспользовать собираемые стадии в таком окружении. Это возможно за счёт механизмов распределённой синхронизации встроенных в werf. Эти механизмы работают исключительно с первичным репозиторием. 
    - Как только стадия попадает в первичный репозиторий, эта стадия может быть переиспользована другими сборочными процессами, которые могут быть запущены с произвольного хоста.
3. Сборочный кеш ранее собранных стадий.
    - Ранее собранные стадии по возможности переиспользуются вместо того, чтобы собираться заново.
    - Данная функция схожа с привычным локальным сборочным кешом в docker server, однако в случае werf этот кеш находится в container registry.
4. Хранилище финальных образов, используемых при запуске приложения в Kubernetes.
    - Kubernetes будет скачивать образы из этого репозитория для запуска контейнеров приложения.
    - В качестве финальных образов напрямую используются те же стадии, из которых состоит собранный образ.

**ВАЖНО.** Для корректной и полноценной работы werf первичный репозиторий должен быть надёжным (persistent) хранилищем, образы из которого удаляются лишь специальной командой очистки `werf cleanup`. Первичный репозиторий это не просто сборочный кеш проекта, но и хранилище его истории, похожее на историю коммитов в git-репозитории.

Помимо первичного репозитория есть другие типы, которые могут выполнять часть его функций. Эти типы будут рассмотрены далее. Однако стоит отметить, что без первичного репозитория werf не работает, все эти репозитории дополнительные, чтобы снять часть функций первичного репозитория в вашей инсталляции проекта.

### Вторичный репозиторий

Задаётся параметром `--secondary-repo` (или переменной окружения `WERF_SECONDARY_REPO_<NAME>`). Может быть указан один или несколько таких репозиториев. 

Данное хранилище — это read-only репозиторий, выполняющий функцию сборочного кеша ранее собранных стадий (см. функции [первичного репозитория](#первичный-репозиторий)).

Как правило в качестве secondary-repo может быть указан уже существующий первичный репозиторий от другой инсталляции проекта. Отсутствующие стадии по мере необходимости будут скопированы из вторичного репозитория в первичный вместо сборки с нуля. Вновь собранные же стадии будут помещены только в первичный репозиторий, потому что вторичный репозиторий всегда read-only, и мы не имеем права в него записывать новые данные.

Очистка вторичного репозитория не является зоной ответственности пользователя вторичного репозитория, т.к. этот репозиторий является первичным в уже существующей инсталляции проекта.

### Кеширующий репозиторий

Задаётся параметром `--cache-repo` (или переменной окружения `WERF_SECONDARY_REPO_<NAME>`). Может быть указан один или несколько таких репозиториев.

Выполняет функцию сборочного кеша ранее собранных стадий (см. функции [первичного репозитория](#первичный-репозиторий)). В отличие от вторичного репозитория, кеширующий репозиторий read-write: используется как для записи новых стадий в кеш, так и для использования собранных стадий из этого кеша.

Существующие стадии будут скопированы из кеширующего репозитория в первичный (первичный репозиторий обязан содержать все собранные стадии образов проекта). Вновь собранные стадии будут опубликованы и в первичный репозиторий, и в кеширующий репозиторий.

Стадии, которые используются в качестве базовых для сборки новых стадий, будут скачиваться из кеша, а если их нету в кеширующем репозитории, то будут скачиваться из первичного репозитория, а затем загружены в кеширующий для дальнейшего использования. Другими словами кеширующий репозиторий заполняется не только вновь собираемыми стадиями, но и базовыми стадиями, используемыми для сборки новых стадий.

Предполагается очистка кеширующего репозитория путём полного его удаления. После очистки такой репозяторий будет вновь наполнен актуальными часто используемыми данными. 

Кеширующий репозиторий никогда не используется при запуске приложения в Kubernetes.

### Финальный репозиторий

Задаётся параметром `--final-repo` (или переменной окружения `WERF_FINAL_REPO`).

Данный репозиторий будет использоваться исключительно для публикации финальных образов, используемых для деплоя приложения в Kubernetes.
 - Вновь собираемые образы попадают сначала в первичный репозиторий, и затем копируются в финальный.
 - Финальный репозиторий никогда не хранит промежуточные стадии образов, лишь последнюю стадию образа.
 - Финальный репозиторий никогда не хранит промежуточные образы (артефакты), нужные для сборки конечных образов. Сюда попадают только конечные образы, используемые в Kubernetes.

Данный репозиторий очищается командой werf-cleanup в паре с первичным репозиторием (необходимо указывать 2 параметра команде `werf cleanup`: `--repo` и `--final-repo`).

## Примеры организации хранилища стадий

Рассмотрим варианты использования и комбинации описанных репозиториев. Стоит отметить, что любой из описанных вариантов требует указания [первичного репозитория](#первичный-репозиторий).

### Стандарт

Первичный репозиторий доступен со всех сборочных хостов, а также из кластера Kubernetes.

При сборке образов сборочный кеш будет скачиваться и загружаться в этот репозиторий. При выкате Kubernetes будет скачивать финальные образы приложения из данного репозитория.

В большинстве случаев следует использовать именно эту схему. Также данная схема подходит, если нет уверенности в том что требуется для проекта.

### Дополнительный кеш в локальной сети

Первичный репозиторий доступен со всех сборочных хостов, а также из кластера Kubernetes.

Кеширующий репозиторий работает в локальной сети с быстрым доступом.

При сборке образов сборочный кеш загружается и в первичный репозиторий, и в кеширующий репозиторий. Стадии образов, требуемые для сборки других стадий, будут скачиваться из кеширующего репозитория.

### Полная оптимизация

Первичный репозиторий располагается в локальной сети с быстрым доступом и доступен со всех сборочных хостов. Доступ к данному репозиторию из кластера Kubernetes не требуется. В отличие от кеширующего репозитория, первичный не может быть полностью очищен или удалён без последствий для работы werf, поэтому требуется обеспечить персистивность и надёжность данного хранилища.

Опционально могут быть подняты дополнительные кеширующие репозитории в локальной сети с быстрым доступом.

Финальный репозиторий располагается близко к кластеру Kubernetes для того, чтобы запускаемое приложение быстро скачивало образы приложения (скачивание финальных образов со стороны Kubernetes будет происходить чаще, чем их загрузка со сборочных хостов). Также к финальному репозиторию требуется доступ на запись со всех сборочных хостов. В финальный репозиторий будут загружены лишь конечные образы приложения (без промежуточных образов артефактов, которые нужны для сборки других образов).
