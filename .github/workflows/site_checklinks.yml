name: Check site and documentation
on:
  push:
    paths:
      - 'docs/**'

jobs:

  integration_tests:
    name: Check documentation consistency
    runs-on: ubuntu-latest

    steps:
      - name: Set up Go 1.13
        uses: actions/setup-go@v1
        with:
          go-version: 1.13
        id: go

      - name: Checkout code
        uses: actions/checkout@v1

      - name: Testing
        run: |
          ./scripts/ci/git.sh

          go test ./integration/docs
        shell: bash

  check_links:
    container: jekyll/builder:3
    name: Check site links
    runs-on: ubuntu-latest
    strategy:
      matrix:
        lang: [ru, en]
    steps:
      - name: Checkout code
        uses: actions/checkout@v1

      - name: Preparing
        run: |
          cd docs
          mkdir -m 777 .jekyll-cache _site
          bundle install

      - name: Building
        if: matrix.lang == 'ru'
        run: |
          cd docs
          cp -rf pages/cli pages_ru
          bundle exec jekyll build --config _config.yml,_config_ru.yml

      - name: Building
        if: matrix.lang == 'en'
        run: |
          cd docs
          bundle exec jekyll build --config _config.yml

      - name: Checking links
        run: |
          cd docs
          bundle exec htmlproofer --allow-hash-href --empty-alt-ignore --check_html --url_ignore "/localhost/,/atseashop.com/,/https\:\/\/t.me/,/.slack.com/,/cncf.io/" ./_site/
